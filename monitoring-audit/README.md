# Monitoring & Audit


## Tools

- CloudWatch:
    - Metrics:
    - Logs:
    - Events:
    - Alarms: React in real-time to metrics / events

- X-Ray:
    - Troubleshooting application performance and errors
    - Distributed tracing of microservices
    
- CloudTrail:
    - Internal monitoring of APi calls being made
    - Audit changes to Resources by users

## CloudWatch

### Metrics

- CW provides metrics for every services in AWS

- __Metric__ is a variable to monitor (CPU utilization, network, ...)

- Metrics belong to __namespaces__

- __Dimension__ is an attribute of a metric (instance id, env, ...)

- Up to 10 dimensions per metric

- Metrics have timestamps

- Create Dashboard

- Use detailed monitoring if u want more prompt scale your ASG

- Possibility to define and send your own custom metrics to CW

- Ability to use dimesions to segment metrics
    - Instance.id
    - Env.name

- Metric resolution:
    - Standard: 1 min
    - __High Resolution__: up to 1s (__StorageResolution__ API params) - higher cost

- Use API call PutMetricData

- Use exponential backoff in case throttle errors

### Alarms

- Alarms are used to trigger notifications for any metrics

- Alarms can go to ASG, EC2 actions, SNS notifications

- Various options (sampling, %, max, min, etc, ...)

- Alarm States:
    - OK: do nothing
    - INSUFFICIENT_DATA: dont send enough data for your alarm
    - ALARM: the alarm threshold is being passed

- Period:
    - Length of time in seconds to evaluate the metric
    - High resolution custom metrics: can only choose 10s or 30s

### Logs

- App can send logs to CW using SDK

- CW can collect log from:
    - Beanstalk: collection of logs from application (env)
    - ECS: collection from containers
    - Lambda
    - VPC Flow logs
    - API Gateway
    - CloudTrail based on filter
    - CW log agents: for example on EC2
    - Route53: Log DNS

- CW logs can go to:
    - Batch exporter to S3 for archival
    - Stream to ElasticSearch cluster for further analytics

- Filter expressions

- Logs storage architecture:
    - Log group:
    - Log stream:

- Define log expiration policies (never expire, 30 days, ...)

- To send logs to CW, __make sure IAM permissions are correct!__

- Security: encryption of logs using KMS at the group level

- Logs Agent vs Unified Agent:
    - For EC2, on-premise servers
    - CW logs agent:
        - Old version
        - Only send to CW logs

    - CW unified agent:
        - Collect additional system-level metrics such as RAM, processes, disk, ram, netstat, swap space, etc, ...
        - Collect logs to send to CW logs
        - Centralized configuration using SSM paramter store
    
- Filter:
    - Usage:
        - Find a specific IP inside of log
        - Count occurrences of ERROR in your logs
        - Metric filters can be used to trigger alarms
        
    - Filter do not retroactively filter data. Filters only publish the metric data points for event that happen after the filter was created

### Events

- Schedule: Cron jobs

- Event pattern: Event rules to react to a service doing something

- Triggers to Lambda functions, SQS, SNS, ...

- CW event creates a small JSON docs to give info about the change

### EventBridge

- EventBridge is the next evolution of CloudWatch Events. EventBridge builds upon and extends CW events


- Default event bus: generated by AWS services (CW Events)

- Partner event bus: receive events from SaaS service or app (Zendesk, DataDog, Segment, Autho0, ...)

- Custom Event buses: for you own app

- Event buses can be accessed by other AWS accounts

